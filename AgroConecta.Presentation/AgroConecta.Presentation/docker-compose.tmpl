services:
  agroconecta-app:
    container_name: agroconecta-app
    image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    networks:
      - enviroment_default
    environment:
      ConnectionStrings__DefaultConnection: Host=$POSTGRESQL_HOST;Database=$POSTGRESQL_DATABASE;Username=$POSTGRESQL_USER;Password=$POSTGRESQL_PASSWORD
      DefaultUser__Email: "$ADMIN_EMAIL"
      DefaultUser__Password: "$ADMIN_PASSWORD"
      VIRTUAL_HOST: agroconecta.elimeletca.com
      LETSENCRYPT_HOST: agroconecta.elimeletca.com
      LETSENCRYPT_EMAIL: elimelet.dev@gmail.com
      VIRTUAL_PORT: '8080'
    build:
      context: .
      dockerfile: AgroConecta.Presentation/AgroConecta.Presentation/Dockerfile
    volumes:
      - agroconecta-dp-keys:/app/DataProtection-Keys
     
  agroconecta-db:
    container_name: $POSTGRESQL_HOST
    image: postgres:16
    volumes:
      - agroconecta-db-data:/var/lib/postgresql/data/pgdata
    restart: always
    networks:
      - enviroment_default
    expose:
      - "5432"
    environment:
      POSTGRES_DB: 'postgres'
      POSTGRES_PASSWORD: '$POSTGRESQL_PASSWORD'
      POSTGRES_USER: '$POSTGRESQL_USER'
      PGDATA: '/var/lib/postgresql/data/pgdata'     
networks:
  enviroment_default:
    external: true
volumes:
  agroconecta-db-data:
  agroconecta-dp-keys:
    driver: local