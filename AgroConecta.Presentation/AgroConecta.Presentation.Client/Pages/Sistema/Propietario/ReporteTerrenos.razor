@page "/sistema/reporte/propietario/terrenos"
@using AgroConecta.Presentation.Client.Agents.Interfaces.Sistema
@using AgroConecta.Presentation.Client.Agents.Interfaces.Sistema.Tipos
@using AgroConecta.Presentation.Client.Components.Formularios
@using AgroConecta.Presentation.Client.Components.Formularios.Tipos
@using AgroConecta.Presentation.Client.Components.General.Alertas
@using AgroConecta.Shared.DTO
@using AgroConecta.Shared.DTO.Tipos
@inject ITerrenoAgent TerrenoAgent
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS


<AuthorizeView Context="authContext">
    <Authorized>
        @if (authContext.User.IsInRole(Shared.Constantes.Seguridad.Roles.Administrador.ToString()))
        {
            <PageTitle>Lista de terrenos</PageTitle>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
            <style>
                .montserrat-900 {
                    font-family: "Montserrat", sans-serif;
                    font-optical-sizing: auto;
                    font-weight: 900;
                    font-style: normal;
                }
                .dark-green {
                    color: #28600a;
                }

                .mud-input > input.mud-input-root-outlined {
                    padding: 14px;
                }

                .mud-data-grid .mud-table-cell .column-header {
                    text-transform: uppercase;
                    color:darkgrey;
                }
                .mud-view-description {
                    color: darkgrey;
                    font-style: italic;
                }

                .mud-table-pagination-caption {
                    color: darkgrey;
                }
                .mud-table {
                    border: 1px solid #e2e2e2;
                }
            </style>
            <MudText Typo="Typo.h4" Class="mb-4 montserrat-900 dark-green">Reporte de terrenos</MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-view-description">
            </MudText>
            <br />
            <MudDataGrid
                Elevation="4"
                T="TerrenoDTO"
                QuickFilter="@_quickFilter"
                Items="@listaTerrenos"
                SortMode="SortMode.Multiple"
                Filterable="true"
                RowsPerPage="10"
                Hideable="true"
                FixedHeader="true"
                Height="calc(61vh - 10rem);"
                Loading="@_isLoadingData"
                LoadingProgressColor="Color.Primary"
            >

                <ToolBarContent>
                    <MudText Typo="Typo.subtitle2">TERRENOS </MudText>
                    <MudSpacer/>
                    <MudStack Row>


                        <MudPaper Elevation="0" Class="">
                            <MudTextField @bind-Value="_searchString"
                                          Variant="Variant.Outlined"
                                          Placeholder="Buscar..."
                                          Adornment="Adornment.Start"
                                          Immediate="true"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          IconSize="Size.Small"
                                          Typo="Typo.caption"
                                          Class="mt-0 mud-search-input-thin "></MudTextField>
                        </MudPaper>
                        <MudPaper Elevation="0" Class="">
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       DropShadow="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                                       OnClick="DescargarReporte">Descargar PDF</MudButton>
                        </MudPaper>
                    </MudStack>
                </ToolBarContent>
                <ColGroup>
                    <col style="width: 80%;" />
                </ColGroup>
                <Columns>
                    <TemplateColumn Title="Provincia" CellClass=" "  Filterable="false">
                        <CellTemplate>
                            <MudStack>
                                <MudText Typo="Typo.body1">@context.Item.DescripcionProvincia</MudText>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Municipio" CellClass=" "  Filterable="false">
                        <CellTemplate>
                            <MudStack>
                                <MudText Typo="Typo.body1">@context.Item.DescripcionMunicipio</MudText>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Tipo suelo" CellClass=" "  Filterable="false">
                        <CellTemplate>
                            <MudStack>
                                <MudText Typo="Typo.body1">@($"Suelo {@context.Item.DescripcionTipoSuelo}") </MudText>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Cantidad de Ã¡rea" CellClass=" "  Filterable="false">
                        <CellTemplate>
                            <MudStack>
                                <MudText Typo="Typo.body1">@($"{@context.Item.CantidadAreaSueloTotal} {@context.Item.DescripcionTipoMedidaArea}") </MudText>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="TerrenoDTO" PageSizeOptions=@(new int[] {5, 10, 15})/>
                </PagerContent>
            </MudDataGrid>
        }
    </Authorized>
</AuthorizeView>

@code {
    private string _searchString;
    private bool _isLoadingData;
    private IEnumerable<TerrenoDTO> listaTerrenos;

    private Func<TerrenoDTO, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        return x.Descripcion.Contains(_searchString, StringComparison.OrdinalIgnoreCase);
    };

    protected override async Task OnInitializedAsync()
    {
        await GetAll();
    }

    private async Task GetAll()
    {
        _isLoadingData = true;
        listaTerrenos = await TerrenoAgent.GetAllAsync(new[]
        {
            "Municipio", "Municipio.Provincia",
            "TipoMedidaArea",
            "TipoSuelo",
            "Propietario"
                
                
        }) ;
        _isLoadingData = false;
        StateHasChanged();
    }

    private async Task DescargarReporte()
    {
        await JS.InvokeVoidAsync("ReporteTerrenos", listaTerrenos);

    }

}