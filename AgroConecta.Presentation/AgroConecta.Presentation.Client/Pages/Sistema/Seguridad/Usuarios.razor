@page "/sistema/seguridad/usuarios"
@using System.Security.Claims
@using AgroConecta.Presentation.Client.Agents.Interfaces.Sistema.Seguridad
@using AgroConecta.Presentation.Client.Components.General.Alertas
@using AgroConecta.Shared.Seguridad
@using AgroConecta.Shared.Seguridad.Mensajes
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar


@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IUsuarioAgent UsuarioAgent
<PageTitle>Lista de Usuarios</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Lista de Usuarios</MudText>

<!-- Contenedor desplazable -->
<MudPaper Style="max-height:500px; overflow-y:auto;">
    <MudTable Items="listaUsuarios" Dense="true">
        <HeaderContent>
            <MudTh>Usuario</MudTh>
            <MudTh>Correo Electrónico</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudText>@context.UserName</MudText>
                <MudText Typo="Typo.caption">@context.Id</MudText>
            </MudTd>
            <MudTd>@context.Email</MudTd>
            <MudTd>
                <MudTooltip Text="Eliminar">
                    <MudIconButton 
                        OnClick="@(() => EliminarUsuario(@context.Id))"
                        Icon="@Icons.Material.Filled.Delete"
                        Color="Color.Error"/>
                </MudTooltip>
                <MudTooltip Text="Administrar roles">
                    <MudIconButton 
                        OnClick="@(() => AdministrarRoles(@context.Id))"
                        Icon="@Icons.Material.Filled.Build" 
                        Color="Color.Tertiary"/>
                </MudTooltip>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

<MessageBox @ref="_messageBox" />

@code {
    private ClaimsPrincipal _usuarioActual;
    private IEnumerable<UsuarioDTO> listaUsuarios = new List<UsuarioDTO>();
    private MessageBox _messageBox;

    protected override async Task OnInitializedAsync()
    {
        var authestate =  await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _usuarioActual = authestate.User;
        await GetAllUsers();
    }
    private async Task GetAllUsers()
    {
        var emailUsuario = _usuarioActual.Claims.FirstOrDefault(c => c.Type == "email")?.Value;
        if (!String.IsNullOrEmpty(emailUsuario))
        {
            listaUsuarios = await UsuarioAgent.GetAllExceptAsync(emailUsuario);
            StateHasChanged();
        }
    }
    

    private async Task EliminarUsuario(string userId)
    {
        if (await UsuarioAgent.DeleteAsync(userId))
        {
            Snackbar.Add("Usuario eliminado correctamente", Severity.Success);
            await GetAllUsers();

        }
    }

    private void AdministrarRoles(string userId)
    {
        // Redirigir a la página de administración de roles
        NavigationManager.NavigateTo($"/sistema/seguridad/rolesusuario/{userId}");
    }
}
